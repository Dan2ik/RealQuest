{% extends 'users/base.html' %}
{% load static %}

{% block title %}Экскурсия: {{ route.name }}{% endblock %}

{% block content %}
    <h1>{{ route.name }}</h1>
    <p>{{ route.description }}</p>

    <div id="panorama-viewer" class="mb-4 rounded shadow-sm border"></div>

    <div id="config-display" class="form-section">
        <h3>Конфигурация Pannellum:</h3>
        <pre><code class="language-json" id="config-json"></code></pre>
    </div>

    {{ pannellum_config|json_script:"pannellum-config-data" }}
{% endblock %}

{% block extra_js %}
    <!-- Pannellum -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <!-- Prism.js для подсветки JSON -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-json.min.js"></script>

    <style>
        #panorama-viewer {
            width: 100%;
            height: 70vh;
            background-color: #eee;
        }

        @media (max-width: 768px) {
            #panorama-viewer {
                height: 60vh;
            }
        }

        .pnlm-hotspot {
            cursor: pointer !important;
        }

        #config-display pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const config = JSON.parse(document.getElementById('pannellum-config-data').textContent);
            document.getElementById('config-json').textContent = JSON.stringify(config, null, 2);

            const viewer = pannellum.viewer('panorama-viewer', config);

            viewer.on('error', function (err) {
                console.error('Pannellum Error:', err.message);
            });

            // Функция обновления прогресса
            function onSceneChange(sceneId) {
                fetch("{% url 'update_progress' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        route_id: {{ route.id }},
                        scene_id: sceneId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.progress !== undefined) {
                        console.log("Прогресс обновлён:", data.progress.toFixed(1) + "%");
                    } else {
                        console.warn("Ошибка при обновлении прогресса:", data.error);
                    }
                })
                .catch(error => {
                    console.error("Ошибка при отправке прогресса:", error);
                });
            }

            // Подписка на смену сцены
            viewer.on('scenechange', function (sceneId) {
                console.log('Переход на сцену:', sceneId);
                onSceneChange(sceneId);
            });
        });
    </script>

{% endblock %}
