<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экскурсия: Пример Направления</title>
    
    <!-- Bootstrap CSS (имитация users/base.html) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Pannellum CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>

    <style>
        /* Кастомизация интерфейса из оригинального шаблона */
        .pnlm-hotspot-base {
            background: rgba(0, 123, 255, 0.7);
            border-radius: 50%;
            cursor: pointer; /* Делаем хотспоты кликабельными */
        }
        .pnlm-hotspot:hover {
            background: rgba(0, 86, 179, 0.8);
        }

        /* Стиль для кастомного тултипа, если вы используете createTooltipFunc */
        .pnlm-hotspot .custom-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            left: 50%;
            top: 0;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none; /* Не блокируем события мыши на хотспоте */
        }
        .pnlm-hotspot:hover .custom-tooltip {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Экскурсия: Пример Направления</h2>
        <p class="text-muted">Маршрут: Пример Маршрута (Западный кампус)</p>

        <!-- Контейнер с обработкой ошибок -->
        <div id="panorama-container" style="width:100%; height:70vh; min-height:500px; position:relative;">
            <div id="panorama-viewer" style="width:100%; height:100%;"></div>
            <div id="panorama-error" style="display:none; position:absolute; top:0; left:0; right:0; bottom:0; background:#f8f9fa; padding:20px; text-align:center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <h3 class="text-danger">Ошибка загрузки панорамы</h3>
                <p id="error-details"></p>
                <button class="btn btn-primary mt-3" onclick="window.location.reload()">Попробовать снова</button>
            </div>
        </div>

        <!-- Pannellum JS -->
        <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Встроенная конфигурация Pannellum (пример)
            // ЗАМЕНИТЕ НА ВАШУ РЕАЛЬНУЮ КОНФИГУРАЦИЮ
            const rawConfig = `
                {
                    "default": {
                        "firstScene": "firstScene",
                        "sceneFadeDuration": 1000,
                        "autoLoad": true,
                        "hfov": 100
                    },
                    "scenes": {
                        "firstScene": {
                            "type": "equirectangular",
                            "panorama": "https://cdn.jsdelivr.net/npm/pannellum@2.5.6/src/images/bunker.jpg",
                            "hotSpots": [
                                {
                                    "pitch": -9,
                                    "yaw": 105,
                                    "cssClass": "custom-hotspot",
                                    "createTooltipFunc": hotspotTooltip,
                                    "createTooltipArgs": "Начальная точка: Бункер"
                                },
                                {
                                    "pitch": -2,
                                    "yaw": -30,
                                    "type": "scene",
                                    "text": "Перейти к солнцу",
                                    "sceneId": "secondScene",
                                    "cssClass": "custom-hotspot",
                                    "createTooltipFunc": hotspotTooltip,
                                    "createTooltipArgs": "Переход к следующей панораме"
                                }
                            ]
                        },
                        "secondScene": {
                            "type": "equirectangular",
                            "panorama": "https://cdn.jsdelivr.net/npm/pannellum@2.5.6/src/images/sun.jpg",
                            "hotSpots": [
                                {
                                    "pitch": 0,
                                    "yaw": -120,
                                    "type": "scene",
                                    "text": "Вернуться к бункеру",
                                    "sceneId": "firstScene",
                                    "cssClass": "custom-hotspot",
                                    "createTooltipFunc": hotspotTooltip,
                                    "createTooltipArgs": "Вернуться назад"
                                },
                                {
                                    "pitch": 10,
                                    "yaw": 0,
                                    "cssClass": "custom-hotspot",
                                    "createTooltipFunc": hotspotTooltip,
                                    "createTooltipArgs": "Информация о Солнце"
                                }
                            ]
                        }
                    }
                }
            `;
            let config;

            try {
                // Парсим JSON-строку
                config = JSON.parse(rawConfig);

                // Если в JSON не указано autoLoad, или firstScene, устанавливаем их по умолчанию
                config.default = config.default || {};
                if (!config.default.firstScene) {
                    config.default.firstScene = Object.keys(config.scenes)[0];
                }
                if (typeof config.default.autoLoad === 'undefined') {
                    config.default.autoLoad = true; // Обычно желательно автозагрузка для маршрута
                }
                config.default.sceneFadeDuration = config.default.sceneFadeDuration || 1000;

                // Проверяем доступность первого изображения
                const testImg = new Image();
                const firstScene = config.scenes[config.default.firstScene];

                if (!firstScene || !firstScene.panorama) {
                    throw new Error("Initial panorama URL missing in configuration.");
                }

                testImg.onload = function() {
                    initPanorama(config);
                };

                testImg.onerror = function() {
                    showError(`Не удалось загрузить изображение: ${firstScene.panorama}`);
                    console.error("Ошибка загрузки изображения:", firstScene.panorama);
                };

                testImg.src = firstScene.panorama;

            } catch (e) {
                showError("Ошибка в конфигурации маршрута");
                console.error("JSON parse error or configuration error:", e);
            }

            // Функция для создания кастомного тултипа Pannellum (если вы используете 'createTooltipFunc')
            function hotspotTooltip(hotSpotDiv, args) {
                hotSpotDiv.classList.add('custom-tooltip-wrapper'); // Добавляем класс для обертки тултипа
                var span = document.createElement('span');
                span.classList.add('custom-tooltip');
                span.innerHTML = args;
                hotSpotDiv.appendChild(span);
            }

            function initPanorama(validConfig) {
                try {
                    const viewer = pannellum.viewer('panorama-viewer', validConfig);

                    // Обработчик ошибок Pannellum
                    viewer.on('error', function(err) {
                        showError(err.error || "Ошибка отображения панорамы");
                        console.error("Pannellum runtime error:", err);
                    });

                    // Можно добавить обработчик изменения сцены
                    viewer.on('scenechange', function(sceneId) {
                        console.log('Сцена изменена на:', sceneId);
                        // Здесь можно обновить информацию на странице, если это нужно
                    });

                } catch (e) {
                    showError("Ошибка инициализации панорамы");
                    console.error("Pannellum init error:", e);
                }
            }

            function showError(message) {
                document.getElementById('panorama-error').style.display = 'flex'; /* flex для центрирования */
                document.getElementById('panorama-viewer').style.display = 'none';
                document.getElementById('error-details').textContent = message;
            }
        });
        </script>

        <div class="mt-4">
            <!-- Ссылка теперь просто заглушка или путь к другому статическому файлу -->
            <a href="#" class="btn btn-outline-primary">
                ← Вернуться к выбору направления
            </a>
        </div>
    </div>

    <!-- Bootstrap JS (опционально, для работы некоторых компонентов Bootstrap) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>