<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор и поиск направлений</title>
    <style>
        /* ... твои стили ... */
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body> <!-- Убери лишний отступ перед body, если он там был -->
    <div class="page-container">
        <h1>Выбор и поиск учебных направлений</h1>

        <!-- Секция для иерархического выбора -->
        <div class="search-section" id="hierarchical-search-section">
            <h2>Иерархический выбор</h2>
            <form method="POST" id="hierarchicalSelectionForm" action="{% url 'academic_structure:combined_selection' %}">
                {% csrf_token %}
                <div class="form-group">
                    {{ hierarchical_form.institute.label_tag }}
                    {{ hierarchical_form.institute }}
                     {% if hierarchical_form.institute.errors %}
                        {% for error in hierarchical_form.institute.errors %}
                            <p class="error-message">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ hierarchical_form.department.label_tag }}
                    {{ hierarchical_form.department }}
                     {% if hierarchical_form.department.errors %}
                        {% for error in hierarchical_form.department.errors %}
                            <p class="error-message">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-group">
                    {{ hierarchical_form.direction.label_tag }}
                    {{ hierarchical_form.direction }}
                     {% if hierarchical_form.direction.errors %}
                        {% for error in hierarchical_form.direction.errors %}
                            <p class="error-message">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="form-group" style="margin-top: 25px;">
                    <button type="submit" class="submit-button">Показать выбранное направление</button>

                    {% if selected_direction and available_routes %}
                    <div class="panorama-buttons" style="margin-top: 20px;">
                        <h4>Доступные панорамы:</h4>
                        <div class="btn-group-vertical" style="width: 100%;">
                            {% for route in available_routes %}
                            <a href="{% url 'excursions:excursion_view' route.id %}"
                               class="btn btn-panorama"
                               target="_blank"
                               style="text-align: left; margin-bottom: 5px; padding: 10px 15px; background-color: #f8f9fa; border: 1px solid #ddd;">
                                <i class="fas fa-street-view" style="margin-right: 8px;"></i>
                                {{ route.name }}
                                <span class="badge bg-primary float-end">Открыть</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% elif selected_direction %}
                    <div class="alert alert-info" style="margin-top: 20px;">
                        Для выбранного направления нет доступных панорам.
                    </div>
                    {% endif %}
                </div>
            </form>

            {% if selected_direction %}
                <div class="results-area">
                    <h3>Выбранное направление (по иерархии):</h3>
                    <p><strong>Название:</strong> {{ selected_direction.name }}</p>
                    <p><strong>Кафедра:</strong> {{ selected_direction.department.name }}</p>
                    <p><strong>Институт:</strong> {{ selected_direction.department.institute.name }}</p>
                </div>
            {% endif %}
        </div>

        <hr class="section-divider">

        <!-- Секция для поиска по названию -->
        <div class="search-section" id="name-search-section">
            <h2>Поиск по названию</h2>
            <form method="GET" id="nameSearchForm" action="{% url 'academic_structure:combined_selection' %}">
                <div class="form-group">
                     {{ search_form.query.label_tag }}
                    <div class="input-group">
                        {{ search_form.query }}
                        <button type="submit">Найти</button>
                    </div>
                </div>
                {% if search_form.query.errors %}
                    {% for error in search_form.query.errors %}
                    <p class="error-message">{{ error }}</p>
                    {% endfor %}
                {% endif %}
            </form>

            {% if search_results %}
                <div class="results-area">
                    <h3>Результаты поиска по названию:</h3>
                    <ul class="results-list">
                        {% for direction_item in search_results %}
                            <li>
                                <strong>{{ direction_item.name }}</strong><br>
                                <small>
                                    Кафедра: {{ direction_item.department.name }}<br>
                                    Институт: {{ direction_item.department.institute.name }}
                                </small>
                            </li>
                        {% endfor %}
                    </ul>
                </div> {# Закрытие .results-area для search_results #}
            {% elif is_search_active and not search_form.errors %}
                 <p class="no-results">По вашему запросу ничего не найдено.</p>
            {% endif %}
        </div> <!-- Закрытие #name-search-section -->
    </div> <!-- Закрытие .page-container -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const instituteSelect = document.getElementById('id_institute');
            const departmentSelect = document.getElementById('id_department');
            const directionSelect = document.getElementById('id_direction');

            function resetAndDisableSelect(selectElement, placeholderText) {
                if (selectElement) {
                    selectElement.innerHTML = `<option value="">${placeholderText}</option>`;
                    selectElement.disabled = true;
                }
            }

            if (instituteSelect) {
                instituteSelect.addEventListener('change', function() {
                    const instituteId = this.value;
                    resetAndDisableSelect(departmentSelect, '--- Сначала выберите институт ---');
                    resetAndDisableSelect(directionSelect, '--- Сначала выберите кафедру ---');

                    if (instituteId) {
                        fetch(`{% url 'academic_structure:ajax_load_departments' %}?institute_id=${instituteId}`)
                            .then(response => response.json())
                            .then(data => {
                                if (departmentSelect) {
                                    let options = '<option value="">--- Выберите кафедру ---</option>';
                                    data.forEach(function(department) {
                                        options += `<option value="${department.id}">${department.name}</option>`;
                                    });
                                    departmentSelect.innerHTML = options;
                                    departmentSelect.disabled = false;
                                }
                            })
                            .catch(error => console.error('Ошибка загрузки кафедр:', error));
                    }
                });
            }

            if (departmentSelect) {
                departmentSelect.addEventListener('change', function() {
                    const departmentId = this.value;
                    resetAndDisableSelect(directionSelect, '--- Сначала выберите кафедру ---');

                    if (departmentId) {
                        fetch(`{% url 'academic_structure:ajax_load_directions' %}?department_id=${departmentId}`)
                            .then(response => response.json())
                            .then(data => {
                                if (directionSelect) {
                                    let options = '<option value="">--- Выберите направление ---</option>';
                                    data.forEach(function(direction) {
                                        options += `<option value="${direction.id}">${direction.name}</option>`;
                                    });
                                    directionSelect.innerHTML = options;
                                    directionSelect.disabled = false;
                                }
                            })
                            .catch(error => console.error('Ошибка загрузки направлений:', error));
                    }
                });
            }

            // Инициализация состояния disabled для иерархической формы при загрузке страницы
            // Это важно, если страница загружается после POST-запроса с ошибками валидации,
            // и `hierarchical_form` уже содержит выбранные значения и заполненные queryset'ы.
            if (instituteSelect && departmentSelect && directionSelect) {
                const isInstituteSelected = instituteSelect.value !== "";
                // departmentSelect.disabled устанавливается на основе isInstituteSelected
                departmentSelect.disabled = !isInstituteSelected;

                // directionSelect.disabled устанавливается на основе isDepartmentSelected И состояния departmentSelect
                const isDepartmentSelectedAndEnabled = departmentSelect.value !== "" && !departmentSelect.disabled;
                directionSelect.disabled = !isDepartmentSelectedAndEnabled;
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


