<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Иерархический выбор направления</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        /* Стили для класса form-control, который ты используешь в виджетах */
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Для правильного расчета ширины с padding и border */
            background-color: #fff;
            color: #495057;
        }
        .form-control:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        select.form-control:disabled {
            background-color: #e9ecef;
            opacity: 1;
        }
        hr { margin-top: 30px; margin-bottom: 30px; border: 0; border-top: 1px solid #eee; }
        .results-section h2 { color: #333; margin-top: 0;}
        .results-section p { margin-bottom: 8px; line-height: 1.6; }
        .results-section strong { color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Иерархический выбор направления</h1>
        <form method="POST" id="selectionForm">
            {% csrf_token %}
            <div class="form-group">
                {{ form.institute.label_tag }}
                {{ form.institute }}
            </div>
            <div class="form-group">
                {{ form.department.label_tag }}
                {{ form.department }}
            </div>
            <div class="form-group">
                {{ form.direction.label_tag }}
                {{ form.direction }}
            </div>
            <!-- Если нужна кнопка для отправки формы для отображения деталей -->
            <!-- <div class="form-group" style="margin-top: 20px;">
                <button type="submit" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Показать информацию</button>
            </div> -->
        </form>

        {% if selected_direction %}
            <hr>
            <div class="results-section">
                <h2>Выбранное направление:</h2>
                <p><strong>Название:</strong> {{ selected_direction.name }}</p>
                <p><strong>Кафедра:</strong> {{ selected_direction.department.name }}</p>
                <p><strong>Институт:</strong> {{ selected_direction.department.institute.name }}</p>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const instituteSelect = document.getElementById('id_institute');
            const departmentSelect = document.getElementById('id_department');
            const directionSelect = document.getElementById('id_direction');

            function resetAndDisableSelect(selectElement, placeholderText) {
                selectElement.innerHTML = `<option value="">${placeholderText}</option>`;
                selectElement.disabled = true;
            }

            instituteSelect.addEventListener('change', function() {
                const instituteId = this.value;
                resetAndDisableSelect(departmentSelect, '--- Сначала выберите институт ---');
                resetAndDisableSelect(directionSelect, '--- Сначала выберите кафедру ---');

                if (instituteId) {
                    fetch(`{% url 'academic_structure:ajax_load_departments' %}?institute_id=${instituteId}`)
                        .then(response => response.json())
                        .then(data => {
                            let options = '<option value="">--- Выберите кафедру ---</option>';
                            data.forEach(function(department) {
                                options += `<option value="${department.id}">${department.name}</option>`;
                            });
                            departmentSelect.innerHTML = options;
                            departmentSelect.disabled = false;
                        })
                        .catch(error => console.error('Ошибка загрузки кафедр:', error));
                }
            });

            departmentSelect.addEventListener('change', function() {
                const departmentId = this.value;
                resetAndDisableSelect(directionSelect, '--- Сначала выберите кафедру ---');

                if (departmentId) {
                    fetch(`{% url 'academic_structure:ajax_load_directions' %}?department_id=${departmentId}`)
                        .then(response => response.json())
                        .then(data => {
                            let options = '<option value="">--- Выберите направление ---</option>';
                            data.forEach(function(direction) {
                                options += `<option value="${direction.id}">${direction.name}</option>`;
                            });
                            directionSelect.innerHTML = options;
                            directionSelect.disabled = false;
                        })
                        .catch(error => console.error('Ошибка загрузки направлений:', error));
                }
            });

            // Изначальная установка состояния disabled, если поля не выбраны (например, при первой загрузке)
            // или если форма была отправлена с ошибками и значения полей сохранились (Django позаботится о queryset'ах)
            if (!instituteSelect.value) {
                departmentSelect.disabled = true;
                directionSelect.disabled = true;
            } else {
                 // Если институт выбран, кафедра должна быть активна (queryset заполнен формой)
                departmentSelect.disabled = false;
                if (!departmentSelect.value || departmentSelect.options.length <= 1) { // <=1 из-за placeholder
                    directionSelect.disabled = true;
                } else {
                    // Если кафедра выбрана, направление должно быть активно
                    directionSelect.disabled = false;
                }
            }
        });
    </script>
</body>
</html>